<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Realtime Database Example</title>

    <!-- Add Firebase to your web app -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>

<script>
    var allData; // Global variable to hold the data

    // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyAvlig_xWJNP1hFsl4qfisC01VTkOAVhT8",
        authDomain: "htshop-e9c51.firebaseapp.com",
        databaseURL: "https://htshop-e9c51-default-rtdb.firebaseio.com",
        projectId: "htshop-e9c51",
        storageBucket: "htshop-e9c51.appspot.com",
        messagingSenderId: "653137640907",
        appId: "1:653137640907:web:672fd6a9e85ca448a70a4e",
        measurementId: "G-FJ4Q0FHBEG"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Reference to your database
    var database = firebase.database();

    // Fetch data from the root of the database
    database.ref().on("value", function(snapshot) {
        allData = snapshot.val(); // Update the global variable
        console.log("All Data:", allData);
        if (allData) {
            displayProductDetails(allData);
        } else {
            console.error("No data available.");
        }
    });

    // Function to display product details
    function displayProductDetails(allData) {
        var output = document.getElementById("output");
        var html = "<h2>Product Details:</h2>";

        var filterValue = document.querySelector('input[name="filter"]:checked').value;
        var searchType = document.querySelector('input[name="searchType"]:checked').value;
        var searchQuery = document.getElementById("search").value.trim().toLowerCase();

        console.log("Search Query:", searchQuery);

        // Convert allData object to an array for sorting and display
        var dataArray = Object.keys(allData).map(key => ({ key, ...allData[key] }));
        dataArray.sort((a, b) => new Date(b.date) - new Date(a.date));

        var foundProduct = false;

        // Iterate over sorted array
        dataArray.forEach(data => {
            if (data.url && data.price && data.outOfStock !== undefined && data.name && data.date) {
                var matchesSearch = false;

                if (searchType === "name") {
                    matchesSearch = data.name.toLowerCase().includes(searchQuery);
                } else if (searchType === "partyCode") {
                    matchesSearch = data.partyCode && data.partyCode.toLowerCase() === searchQuery;
                }

                if (((filterValue === "true" && data.outOfStock) || (filterValue === "false" && !data.outOfStock)) &&
                    (searchQuery === '' || matchesSearch)) {

                    html += `<div class="product" id="${data.key}" draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" style="border: 1px solid #ccc; margin: 10px; padding: 10px;">`;
                    html += '<img src="' + data.url + '" loading="lazy" alt="Product Image" width="100">';
                    html += "<p><strong>Name:</strong> " + data.name + "</p>";
                    html += "<p><strong>Price:</strong> " + data.price + " USD</p>";
                    html += "<p><strong>Party code:</strong> " + (data.partyCode || 'N/A') + "</p>";
                    html += "<p><strong>Out of Stock:</strong> " + (data.outOfStock ? "Yes" : "No") + "</p>";
                    html += "<p><strong>Date:</strong> " + new Date(data.date).toLocaleString() + "</p>";
                    html += '<button onclick="deleteProduct(\'' + data.key + '\')">Delete Product</button></div>';

                    foundProduct = true;
                }
            }
        });

        output.innerHTML = foundProduct ? html : "<p>No products found matching the search criteria.</p>";
    }

    // Allow dropping
    function allowDrop(event) {
        event.preventDefault();
    }

    // Set data for drag
    function drag(event) {
        event.dataTransfer.setData("text/plain", event.target.id); // Set the ID of the dragged item
        console.log("Dragging ID:", event.target.id);
    }

    // Handle drop
    function drop(event) {
        event.preventDefault();

        var draggedId = event.dataTransfer.getData("text/plain");
        var targetElement = event.target.closest('.product');

        if (targetElement) {
            var targetId = targetElement.id;

            if (draggedId !== targetId) {
                updateProductOrder(draggedId, targetId);
            } else {
                console.warn("Cannot drop an item on itself.");
            }
        } else {
            console.error("Drop target is not a valid product.");
        }
    }

    // Update product order
    function updateProductOrder(draggedId, targetId) {
        const draggedElement = allData[draggedId];
        const targetElement = allData[targetId];

        // Validate both elements are defined
        if (!draggedElement || !targetElement) {
            console.error("Either dragged or target element is undefined");
            console.log(" draggedElement:", draggedElement);
            console.log(" targetElement:", targetElement);
            return; // Prevent further execution if undefined
        }

        // Log the elements before swapping
        console.log("Before Swapping:", {
            draggedElement: draggedElement,
            targetElement: targetElement
        });

        // Swap product dates (or whatever property needs to be swapped)
        const tempDate = draggedElement.date;
        draggedElement.date = targetElement.date;
        targetElement.date = tempDate;

        // Update the Firebase database
        database.ref(draggedId).set(draggedElement).then(() => {
            console.log("Dragged element updated in the database.");
        });
        database.ref(targetId).set(targetElement).then(() => {
            console.log("Target element updated in the database.");
        });

        // Refresh displayed products
        displayProductDetails(allData);
    }

    // Delete product function
    function deleteProduct(key) {
        var confirmDelete = confirm("Are you sure you want to delete this product?");
        if (confirmDelete) {
            database.ref(key).remove()
                .then(function () {
                    console.log("Product deleted successfully");
                })
                .catch(function (error) {
                    console.error("Error deleting product: ", error);
                });
        }
    }
</script>

<!-- Form for filtering data -->
<form>
    <label>
        <input type="radio" name="filter" value="true" checked> Show Out of Stock
    </label>
    <label>
        <input type="radio" name="filter" value="false"> Show In Stock
    </label>
</form>

<!-- Form for selecting search type -->
<form>
    <label>
        <input type="radio" name="searchType" value="name" checked> Search by Name
    </label>
    <label>
        <input type="radio" name="searchType" value="partyCode"> Search by Party Code
    </label>
</form>

<!-- Input field for searching by name or party code -->
<input type="text" id="search" placeholder="Search by name or party code" oninput="displayProductDetails(allData)">

<!-- Display area for product details -->
<div id="output"></div>

</body>

  
  
</html>
